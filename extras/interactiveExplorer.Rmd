---
title: "Interactive Prediction Model Performance Explorer"
output: html_document
---

```{r setup, include=FALSE}
# ============================================================================
# SETUP AND DATA LOADING
# ============================================================================
# This chunk loads all necessary packages and the final results data.
# It is completely self-contained.

library(dplyr)
library(plotly)
library(crosstalk)
library(htmltools)
library(ggthemes)
library(tidyr)
library(PandemicPrediction)

# --- Load the master results data frame ---
# Make sure you have saved your 'allResults' object to this file first.
# Example: saveRDS(allResults, "all_results.rds")
if (file.exists("all_results.rds")) {
  allResults <- readRDS("all_results.rds")
} else {
  allResults <- dplyr::bind_rows(
  getAnalysisResults(
    databasePath = "../results/development/databaseFile.sqlite",
    evaluationType = "Test",
    analysisId = "dev"
  ),
  getAnalysisResults(
    databasePath = "../results/validation/databaseFile.sqlite",
    evaluationType = "Validation",
    analysisId = "val_original"
  ),
  getAnalysisResults(
    databasePath = "../results/new-model-validation/databaseFile.sqlite",
    evaluationType = "Validation",
    analysisId = "val_new"
  )
)
}
unifiedResults <- allResults |>
  dplyr::mutate(
    plotStartDate = dplyr::if_else(analysisId == "dev", devStartDate, startDate),
    plotEndDate = dplyr::if_else(analysisId == "dev", devEndDate, endDate),
    lineType = dplyr::if_else(analysisId == "dev", "dash", "solid"),
    hoverText = dplyr::case_when(
      analysisId == "dev" ~ paste(
        "<b>Development Performance</b>",
        "<br><b>Model:</b>", legendLabel,
        "<br><b>AUROC:</b>", round(AUROC, 4),
        "<br><b>Dev Period:</b>", format(devStartDate, "%Y-%m-%d"), "to", format(devEndDate, "%Y-%m-%d")
      ),
      TRUE ~ paste(
        "<b>Validation Performance</b>",
        "<br><b>Model:</b>", legendLabel,
        "<br><b>AUROC:</b>", round(AUROC, 4),
        "<br><b>Validation Period:</b>", format(startDate, "%Y-%m-%d"), "to", format(endDate, "%Y-%m-%d"),
        "<br><b>Population:</b>", populationSize,
        "<br><b>Outcomes:</b>", outcomeCount
      )
    )
  )

unifiedResults <- unifiedResults |>
  dplyr::mutate(
    outcomeShort = substr(.data$outcomeName, 1, 1),
    featShort = substr(.data$featureSet, 1, 1),
    originShort = dplyr::case_when(
      .data$modelOrigin == "Original Influenza" ~ "Inf",
      .data$modelOrigin == "New Covid" ~ "Cov",
      TRUE ~ "Unk"
    ),
    devShort = dplyr::recode(
      .data$devPeriod,
      "First 3 Months" = "3m",
      "First 6 Months" = "6m",
      "First 9 Months" = "9m",
      "Full Year 2020 (Sampled)" = "FY-S",
      "Full Year 2020 (Full Pop.)" = "FY-FP",
      .default = NA_character_
    ),
    legendShort = dplyr::if_else(
      .data$modelOrigin == "New Covid",
      paste0(.data$outcomeShort, "-", .data$featShort, " ", .data$originShort, " ", .data$devShort),
      paste0(.data$outcomeShort, "-", .data$featShort, " ", .data$originShort)
    )
  )

# --- SharedData and plotting prep (match ggplot styling) ---
sharedAll <- SharedData$new(unifiedResults, ~fullName, group = "models")

# Expand non-Covid rows across all Covid dev-period levels so the devPeriod filter retains Influenza
devLevels <- unifiedResults |>
  dplyr::filter(.data$modelOrigin == "New Covid", !is.na(.data$devPeriod)) |>
  dplyr::distinct(.data$devPeriod) |>
  dplyr::pull(.data$devPeriod) |>
  as.character()

expand_by_dev <- function(df, devLevels) {
  inf <- df |> dplyr::filter(.data$modelOrigin != "New Covid")
  if (length(devLevels) > 0 && nrow(inf) > 0) {
    inf_exp <- tidyr::crossing(
      inf |> dplyr::select(-dplyr::any_of("devPeriod")),
      devPeriod = devLevels
    )
    dplyr::bind_rows(
      df |> dplyr::filter(.data$modelOrigin == "New Covid"),
      inf_exp
    )
  } else {
    df
  }
}

expandedUnified <- expand_by_dev(unifiedResults, devLevels)
devData <- expandedUnified |> dplyr::filter(.data$analysisId == "dev")
valData <- expandedUnified |> dplyr::filter(.data$analysisId != "dev")

allLevels <- sort(unique(c(valData$fullName, devData$fullName)))
devData$fullName <- factor(devData$fullName, levels = allLevels)
valData$fullName <- factor(valData$fullName, levels = allLevels)

# Safer color palette (avoid white/too-light colors)
safePalette <- function(n) {
  if (n <= 8) {
    pal <- ggthemes::colorblind_pal()(n)
  } else {
    pal <- ggthemes::tableau_color_pal("Tableau 20")(n)
  }
  getLum <- function(hex) {
    rgb <- grDevices::col2rgb(hex) / 255
    0.2126 * rgb[1, ] + 0.7152 * rgb[2, ] + 0.0722 * rgb[3, ]
  }
  tooLight <- getLum(pal) > 0.92
  pal[tooLight] <- "#7F7F7F"
  pal
}
palette <- safePalette(length(allLevels))

xRange <- dplyr::bind_rows(
  dplyr::select(valData, start = startDate, end = endDate),
  dplyr::select(devData, start = devStartDate, end = devEndDate)
) |>
  dplyr::summarise(
    xmin = min(start, na.rm = TRUE),
    xmax = max(end, na.rm = TRUE)
  ) |>
  dplyr::mutate(
    span = as.numeric(xmax - xmin),
    legendX = xmax - pmax(2, ceiling(0.02 * span))
  ) |>
  dplyr::slice(1)

# Add POSIXct columns for clean date formatting in tooltips
valData <- valData |>
  dplyr::mutate(
    startDateTime = as.POSIXct(.data$startDate),
    endDateTime = as.POSIXct(.data$endDate)
  )
devData <- devData |>
  dplyr::mutate(
    devStartDateTime = as.POSIXct(.data$devStartDate),
    devEndDateTime = as.POSIXct(.data$devEndDate)
  )

sharedAll <- SharedData$new(expandedUnified, ~fullName, group = "models")
sharedDev <- SharedData$new(devData, ~fullName, group = "models")
sharedVal <- SharedData$new(valData, ~fullName, group = "models")
```
<style>
/* Optional CSS for a cleaner layout */
.container {
display: flex;
flex-direction: row;
gap: 20px;
}
.filters {
flex: 1;
min-width: 200px;
}
.plot {
flex: 4;
}
</style>
<div class="container">
<div class="filters">
Filters
```{r filters, echo=FALSE}
# ============================================================================
# UI FILTER CONTROLS
# ============================================================================

# --- Create a Crosstalk "SharedData" object ---
# This is the magic that allows filters and plots to communicate.

# These create the interactive dropdowns and checkboxes.
div(
  style = "font-size: 14px;", # Smaller font for the filter panel
  filter_select(
    id = "outcome",
    label = "Select Outcome:",
    sharedData = sharedAll,
    group = ~outcomeName
  ),
  hr(), # Horizontal line for separation

  h4("Model Attributes"),
  filter_checkbox(
    id = "modelorigin",
    label = "Model Origin:",
    sharedData = sharedAll,
    group = ~modelOrigin,
    inline = FALSE # Stack the checkboxes vertically
  ),
  filter_checkbox(
    id = "featureset",
    label = "Feature Set:",
    sharedData = sharedAll,
    group = ~featureSet,
    inline = FALSE
  ),
  filter_checkbox(
    id = "devperiod",
    label = "Development Period:",
    sharedData = sharedAll,
    group = ~devPeriod,
    inline = FALSE
  )
)
```
</div>
<div class="plot">
```{r plot, echo=FALSE, message=FALSE, warning=FALSE}
# ============================================================================
# INTERACTIVE PLOT
# ============================================================================
# This code creates the main plot using plotly, linked to the filters.

# Prepare the two data layers: validation lines and development lines
# --- Create a Crosstalk "SharedData" object ---
# This is the magic that allows filters and plots to communicate.

# Create the plot
p <- plot_ly(source = "main_plot") |>
  # Validation segments (solid)
  add_segments(
    data = sharedVal,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~startDate, xend = ~endDate,
    y = ~AUROC, yend = ~AUROC,
    name = ~legendShort,
    legendgroup = ~fullName,
    line = list(width = 1.2, dash = "solid"),
    text = ~paste0(
      "<b>", legendShort, "</b><br>",
      "AUROC: ", sprintf("%.3f", AUROC), "<br>",
      "Validation: ", format(startDateTime, "%Y-%m-%d"), " \u2192 ", format(endDateTime, "%Y-%m-%d"), "<br>",
      "N: ", format(populationSize, big.mark = ",", scientific = FALSE),
      "  |  Outcomes: ", format(outcomeCount, big.mark = ",", scientific = FALSE)
    ),
    hovertemplate = "%{text}<extra></extra>",
    showlegend = TRUE
  ) |>
  # Development segments (dashed)
  add_segments(
    data = sharedDev,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~devStartDate, xend = ~devEndDate,
    y = ~AUROC, yend = ~AUROC,
    name = ~legendShort,
    legendgroup = ~fullName,
    line = list(width = 1.2, dash = "dash"),
    text = ~paste0(
      "<b>", legendShort, "</b><br>",
      "AUROC: ", sprintf("%.3f", AUROC), "<br>",
      "Development: ", format(devStartDateTime, "%Y-%m-%d"), " \u2192 ", format(devEndDateTime, "%Y-%m-%d")
    ),
    hovertemplate = "%{text}<extra></extra>",
    showlegend = FALSE
  ) |>
  # Validation markers at segment ends
  add_markers(
    data = sharedVal,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~startDate, y = ~AUROC,
    legendgroup = ~fullName,
    showlegend = FALSE, hoverinfo = "none"
  ) |>
  add_markers(
    data = sharedVal,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~endDate, y = ~AUROC,
    legendgroup = ~fullName,
    showlegend = FALSE, hoverinfo = "none"
  ) |>
  layout(
    title = "Interactive Model Performance Explorer",
    xaxis = list(
      title = "Validation Period",
      type = "date",
      range = c(xRange$xmin, xRange$xmax),
      tickformat = "%b %Y",
      dtick = "M3",
      tickangle = 45,
      rangeslider = list(visible = TRUE),
      showspikes = TRUE,
      spikemode = "across",
      spikesnap = "cursor",
      spikecolor = "rgba(0,0,0,0.25)",
      spikethickness = 1
    ),
    yaxis = list(title = "AUROC", range = c(0.5, 1)),
    hovermode = "x unified",
    hoverlabel = list(font = list(size = 11)),
    showlegend = TRUE,
    legend = list(
      orientation = "v",
      x = 1.02, xanchor = "left",
      y = 1, yanchor = "top",
      font = list(size = 11),
      itemsizing = "constant",
      itemwidth = 20,
      itemclick = "toggleothers",
      itemdoubleclick = "toggle"
    ),
    margin = list(t = 60, r = 180, b = 100, l = 60)
  )

# Print the final plot
p
```  
</div>
</div>
