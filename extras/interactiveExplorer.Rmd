---
title: "Interactive Prediction Model Performance Explorer"
output: html_document
---

```{r setup, include=FALSE}
# ============================================================================
# SETUP AND DATA LOADING
# ============================================================================
# This chunk loads all necessary packages and the final results data.
# It is completely self-contained.

library(dplyr)
library(plotly)
library(crosstalk)
library(htmltools)
library(ggthemes)
library(PandemicPrediction)

# --- Load the master results data frame ---
# Make sure you have saved your 'allResults' object to this file first.
# Example: saveRDS(allResults, "all_results.rds")
if (file.exists("all_results.rds")) {
  allResults <- readRDS("all_results.rds")
} else {
  allResults <- dplyr::bind_rows(
  getAnalysisResults(
    databasePath = "../results/development/databaseFile.sqlite",
    evaluationType = "Test",
    analysisId = "dev"
  ),
  getAnalysisResults(
    databasePath = "../results/validation/databaseFile.sqlite",
    evaluationType = "Validation",
    analysisId = "val_original"
  ),
  getAnalysisResults(
    databasePath = "../results/new-model-validation/databaseFile.sqlite",
    evaluationType = "Validation",
    analysisId = "val_new"
  )
)
}
unifiedResults <- allResults |>
  dplyr::mutate(
    plotStartDate = dplyr::if_else(analysisId == "dev", devStartDate, startDate),
    plotEndDate = dplyr::if_else(analysisId == "dev", devEndDate, endDate),
    lineType = dplyr::if_else(analysisId == "dev", "dash", "solid"),
    hoverText = dplyr::case_when(
      analysisId == "dev" ~ paste(
        "<b>Development Performance</b>",
        "<br><b>Model:</b>", legendLabel,
        "<br><b>AUROC:</b>", round(AUROC, 4),
        "<br><b>Dev Period:</b>", format(devStartDate, "%Y-%m-%d"), "to", format(devEndDate, "%Y-%m-%d")
      ),
      TRUE ~ paste(
        "<b>Validation Performance</b>",
        "<br><b>Model:</b>", legendLabel,
        "<br><b>AUROC:</b>", round(AUROC, 4),
        "<br><b>Validation Period:</b>", format(startDate, "%Y-%m-%d"), "to", format(endDate, "%Y-%m-%d"),
        "<br><b>Population:</b>", populationSize,
        "<br><b>Outcomes:</b>", outcomeCount
      )
    )
  )

# --- SharedData and plotting prep (match ggplot styling) ---
sharedAll <- SharedData$new(unifiedResults, ~fullName, group = "models")

devData <- unifiedResults |> dplyr::filter(analysisId == "dev")
valData <- unifiedResults |> dplyr::filter(analysisId != "dev")

allLevels <- sort(unique(c(valData$fullName, devData$fullName)))
devData$fullName <- factor(devData$fullName, levels = allLevels)
valData$fullName <- factor(valData$fullName, levels = allLevels)

palette <- ggthemes::tableau_color_pal("Tableau 20")(length(allLevels))

xRange <- dplyr::bind_rows(
  dplyr::select(valData, start = startDate, end = endDate),
  dplyr::select(devData, start = devStartDate, end = devEndDate)
) |>
  dplyr::summarise(
    xmin = min(start, na.rm = TRUE),
    xmax = max(end, na.rm = TRUE)
  ) |>
  dplyr::mutate(
    span = as.numeric(xmax - xmin),
    legendX = xmax - pmax(2, ceiling(0.02 * span))
  ) |>
  dplyr::slice(1)


sharedDev <- SharedData$new(devData, ~fullName, group = "models")
sharedVal <- SharedData$new(valData, ~fullName, group = "models")
```
<style>
/* Optional CSS for a cleaner layout */
.container {
display: flex;
flex-direction: row;
gap: 20px;
}
.filters {
flex: 1;
min-width: 200px;
}
.plot {
flex: 4;
}
</style>
<div class="container">
<div class="filters">
Filters
```{r filters, echo=FALSE}
# ============================================================================
# UI FILTER CONTROLS
# ============================================================================

# --- Create a Crosstalk "SharedData" object ---
# This is the magic that allows filters and plots to communicate.

# These create the interactive dropdowns and checkboxes.
div(
  style = "font-size: 14px;", # Smaller font for the filter panel
  filter_select(
    id = "outcome",
    label = "Select Outcome:",
    sharedData = sharedAll,
    group = ~outcomeName
  ),
  hr(), # Horizontal line for separation

  h4("Model Attributes"),
  filter_checkbox(
    id = "modelorigin",
    label = "Model Origin:",
    sharedData = sharedAll,
    group = ~modelOrigin,
    inline = FALSE # Stack the checkboxes vertically
  ),
  filter_checkbox(
    id = "featureset",
    label = "Feature Set:",
    sharedData = sharedAll,
    group = ~featureSet,
    inline = FALSE
  ),
  filter_checkbox(
    id = "devperiod",
    label = "Development Period:",
    sharedData = sharedAll,
    group = ~devPeriod,
    inline = FALSE
  )
)
```
</div>
<div class="plot">
```{r plot, echo=FALSE, message=FALSE, warning=FALSE}
# ============================================================================
# INTERACTIVE PLOT
# ============================================================================
# This code creates the main plot using plotly, linked to the filters.

# Prepare the two data layers: validation lines and development lines
# --- Create a Crosstalk "SharedData" object ---
# This is the magic that allows filters and plots to communicate.

# Create the plot
p <- plot_ly(source = "main_plot") |>
  # Validation segments (solid)
  add_segments(
    data = sharedVal,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~startDate, xend = ~endDate,
    y = ~AUROC, yend = ~AUROC,
    line = list(width = 1.2, dash = "solid"),
    hoverinfo = "text", text = ~hoverText,
    showlegend = TRUE,
    legendgroup = ~fullName
  ) |>
  # Development segments (dashed)
  add_segments(
    data = sharedDev,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~devStartDate, xend = ~devEndDate,
    y = ~AUROC, yend = ~AUROC,
    line = list(width = 1.2, dash = "dash"),
    hoverinfo = "text", text = ~hoverText,
    legendgroup = ~fullName,
    showlegend = FALSE
  ) |>
  # Validation markers at segment ends
  add_markers(
    data = sharedVal,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~startDate, y = ~AUROC,
    legendgroup = ~fullName,
    showlegend = FALSE, hoverinfo = "none"
  ) |>
  add_markers(
    data = sharedVal,
    split = ~fullName, color = ~fullName, colors = palette,
    x = ~endDate, y = ~AUROC,
    legendgroup = ~fullName,
    showlegend = FALSE, hoverinfo = "none"
  ) |>
  layout(
    title = "Interactive Model Performance Explorer",
    xaxis = list(
      title = "Validation Period",
      type = "date",
      range = c(xRange$xmin, xRange$xmax),
      tickformat = "%b %Y",
      dtick = "M3",
      tickangle = 45
    ),
    yaxis = list(title = "AUROC", range = c(0.5, 1)),
    hovermode = "x unified",
    showlegend = TRUE,
    legend = list(
      orientation = "v",
      x = 1.02, xanchor = "left",
      y = 1, yanchor = "top",
      font = list(size = 12),
      itemclick = "toggleothers",
      itemdoubleclick = "toggle"
    ),
    margin = list(t = 60, r = 240, b = 60, l = 60)
  )

# Print the final plot
p
```  
</div>
</div>
